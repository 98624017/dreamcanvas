# 即梦独立客户端功能需求说明 (v1.5)

> 更新于 2025年9月22日，基于 DreamCanvas 项目策略重构并加入分阶段交付目标。

## 1. 项目概述
- **产品定位**：通过浏览器访问、依托桌面助手的多项目 AI 视觉创作中心。
- **目标用户**：需要集中管理提示词、素材和即梦账号的设计师、工作室、内容运营团队。
- **核心价值**：围绕“项目”为单位提供从创意草图、AI 生成、编辑到资产沉淀的闭环，同时保证团队协作与资产复用。
- **关键假设**：用户具备即梦账号并愿意在本地运行轻量 Python 后端；允许安装桌面助手并配置代理（如有需要）。

### 1.1 用户关键需求
- 快速切换项目并保留画布上下文，避免重复拼装素材。
- 以最少步骤将 AI 生成结果同步到画布和素材库，支持迭代微调。
- 对生成失败、账号额度不足等异常提供明确指引与恢复手段。
- 在安全前提下集中管理多账号 session，并具备日志可追溯能力。

## 2. 版本与里程碑规划

| 阶段 | 时间窗口 | 核心目标 | 验收指标 |
| --- | --- | --- | --- |
| P0 环境基线 | 2025 Q4 W1-W2 | 完成跨平台开发环境、凭据管理与数据目录规范；建立自动化检查脚本 | 前端/后端均可启动；`.env` 模板与密钥加密流程落地；项目数据自动备份成功率≥95% |
| P1 MVP Alpha | 2025 Q4 W3-W6 | 打通单项目核心流程：画布、素材库、即梦文生图与抠图，提供基础异常处理 | 关键用户路径（导入素材→生成→存库）成功率≥90%；任务失败重试覆盖常见错误码 |
| P2 Beta 扩展 | 2025 Q4 W7-W10 | 引入多项目资产复用、AI 视觉助理、提示词上下文面板及权限控制 | 支持≥5个项目数据并行；跨项目资产复制耗时<2s；AI 助手 SLA 95% |
| P3 GA 稳定 | 2026 Q1 W1-W4 | 打磨性能、可观察性和备份恢复；准备公开发布 | 首次渲染<200ms；任务超时告警覆盖率>95%；提供升级与回滚流程文档 |

> 每个阶段结束必须产出：阶段回顾、功能演示、问题清单、迭代计划。任何阶段阻塞项需在 48 小时内备案。

## 3. 功能范围与优先级

### 3.1 画布与创作工具
- 【P1】基础画布：集成 Tldraw 无限画布，支持缩放、拖拽、撤销/重做，并与项目自动保存。
- 【P1】元素操作：图片、文本、形状的新增、选中、层级管理、锁定与删除。
- 【P1】生成回收：即梦或助手生成结果自动落地为节点，带元数据标记来源。
- 【P2】AI 草图转组件：选区截图上传至视觉助理，返回 UI 组件或图形并可继续编辑。
- 【P3】画布版本快照：按项目与日期生成快照，可回滚并比较差异。

### 3.2 项目与资产管理
- 【P0】项目目录规范：所有项目数据以 JSON 与二进制形式存放于 `%APPDATA%/DreamCanvas/projects/{projectId}/`。
- 【P1】项目 CRUD：创建、加载、重命名、最近项目列表；自动保存间隔≤5 秒，保存失败需提示并重试。
- 【P1】素材库：支持图片、文本提示、生成组件三类资产，一键入库或拖拽回画布。
- 【P2】跨项目共享：资产库可一键复制到目标项目，记录原始来源与时间。
- 【P3】备份与恢复：每日增量备份到 `%APPDATA%/DreamCanvas/backups/`，保留最近 7 天。

### 3.3 提示词与上下文管理
- 【P1】提示词输入：提供主提示输入框，支持快捷键提交与历史列表。
- 【P1】上下文面板：展示画布选区、素材库引用，支持拖拽排序和一键清除。
- 【P2】快捷引用：选中元素后可一键写入上下文，并选择是否引用图片、颜色、文本。
- 【P3】提示词模板：允许用户保存模板并按项目共享。

### 3.4 即梦 API 生图
- 【P1】任务发起：支持文生图，提供模型、尺寸、批次数配置。
- 【P1】任务状态：实时展示排队、生成、失败状态，并允许用户取消。
- 【P1】失败降级：针对 1015/1016/1003 错误提供自动重试策略与手动切换账号选项。
- 【P2】图生图/参考图：支持上传本地或画布选中图片作为参考，自动生成 image_uri。
- 【P3】高清增强：提供高清增强任务入口，可配置输出目录。

### 3.5 AI 文本与视觉助手
- 【P1】文本助手：悬浮窗口支持润色提示词、生成灵感，调用 LLM 文本端点。
- 【P2】视觉助手：支持草图识别与对话式微调，结果可入库。
- 【P3】脱机提示：当外部 LLM 不可用时提供离线备选策略或提示。

### 3.6 系统与账号支持
- 【P0】桌面助手与 Python 后端的安装、自检脚本、日志目录 (`%LOCALAPPDATA%/DreamCanvas/logs`)。
- 【P1】账号管理：录入多个 sessionid，提供可用性与积分监控。
- 【P1】诊断中心：整合日志导出、API 请求追踪、版本信息。
- 【P2】权限与审计：为团队模式预留账号权限与操作日志接口。

## 4. 非功能性指标
- **性能**：首屏加载≤3 秒；画布交互响应≤200 毫秒；资产库检索≤1 秒。
- **可靠性**：自动保存失败重试次数≥3 次；关键 API 成功率≥97%；本地备份成功率≥95%。
- **可扩展性**：项目数据结构支持插件字段；外部服务请求集中通过适配层，方便替换供应商。
- **可观察性**：提供基础埋点（任务耗时、失败原因），并输出 JSON 日志，可接入 ELK。
- **可维护性**：新增模型或账号时，仅需更新配置文件而无需改动核心代码。

## 5. 数据与配置策略
- **存储结构**：以项目 ID 建目录，包含 `canvas.json`、`assets/`、`history/`、`snapshots/`，并维护 `manifest.json` 描述版本与校验信息。
- **同步策略**：写入流程采取“写临时文件→校验→原子替换”，防止数据损坏。
- **备份策略**：每日 02:00 创建增量包，`.bak` 文件加密存储，保留 7 天；支持用户手动触发全量备份。
- **配置管理**：提供 `config/default.env` 模板，实际密钥保存在 `config/secrets.enc`，通过桌面助手以用户主密码解密。
- **日志保留**：系统日志按天切分，超过 14 天自动归档压缩。

## 6. 安全与合规要求
- **凭据管理**：sessionid、API Key 必须经过 AES-256 加密后持久化，并支持一键失效与更新；禁止明文写入日志。
- **最小权限**：Python 后端默认在本地回环地址提供服务，外部端口对用户可配置；所有网络请求需遵守速率限制。
- **异常告警**：当任务失败累计超过 3 次或积分低于阈值时，提醒用户并生成诊断报告。
- **审计轨迹**：记录敏感操作（账号新增、备份恢复、批量删除），日志包含操作者、时间、参数摘要。

## 7. 风险与依赖
- **外部接口变化**：需每两周验证即梦与 Cloudflare Gateway 协议，如发现异常 24 小时内提供临时补丁。
- **性能瓶颈**：AI 抠图与图生图高负载会影响体验，提前预留队列与超时策略。
- **团队协作**：多人并发编辑尚未纳入本期范围，需防止用户误解；未来版本需评估实时协作方案。
- **法律合规**：提示用户遵守即梦使用条款，避免分享或滥用 sessionid。

## 8. 关键用户流程
1. **初始化 (P0)**：桌面助手执行环境自检→用户导入 sessionid → 加密写入 → 创建首个项目。
2. **创作闭环 (P1)**：导入素材→画布编排→提示词提交→即梦生成→结果自动回收→选择入库→自动保存项目。
3. **跨项目复用 (P2)**：在项目 A 入库资产→在项目 B 资产库检索→复制并落地→记录来源链路。
4. **灾备恢复 (P3)**：触发异常→系统写入故障报告→用户点选最近备份→恢复项目并生成对比日志。

## 9. 交付物清单
- 需求文档与设计稿：各阶段需同步更新。
- 环境与部署脚本：PowerShell 与 Python 双平台脚本、`.env` 模板、密钥加密工具。
- 测试用例：覆盖核心流程、异常分支与安全用例，提交时附带覆盖率报告；E2E 用例统一存放在 `apps/desktop/playwright/` 并在 CI 可选执行。
- 用户手册：包含账号配置、安全指引、常见问题。

## 10. 质量保障与自动化测试规划
- **阶段目标**：
  - 【P0】建立基础 CI 流水线（GitHub Actions 或自建 Runner），跑 `pnpm lint`、`pnpm test --filter web`、`poetry run pytest`；生成覆盖率与基线性能快照。
  - 【P1】补齐画布核心流程的集成测试与后端任务重试用例，E2E 场景（创建项目→生成任务→入库）以 Playwright 脚本固定；脚本需支持 Mock 后端与 CI 执行。
  - 【P2】引入可视化回归（画布截图比对）与助手对话模拟，增加备份恢复与跨项目资产复制的自动化脚本。
  - 【P3】完成性能压测（k6）与故障演练自动化，发布前自动生成 QA 报告。
- **质量门槛**：单元测试覆盖率保持 ≥75%，关键路径 E2E 用例在合并前强制执行；性能基线与失败重试统计需作为 PR 审核项。
- **缺陷管理**：所有缺陷按优先级进入迭代看板，P1 及之后阶段要求关键阻塞缺陷在 24 小时内给出临时方案。

## 11. 版本控制与发布节奏
- **分支策略**：采用 `main` + `develop` + 阶段分支模型。每个里程碑维护 `release/Px` 分支，支撑阶段内迭代与回滚。
- **标签规范**：阶段完成后在 `main` 上打 `v{stage}.{iteration}.{patch}` 标签（如 `vP1.0.0`），附带发布说明与验收报告链接。
- **冻结窗口**：进入里程碑最终一周启动代码冻结，仅接受阻断性修复；冻结期间 PR 需双人评审与测试佐证。
- **回滚流程**：每个阶段必须准备 `rollback.md`，记录可回退的标签、脚本与数据恢复步骤；CI 发布脚本在成功后自动生成快照。
- **变更审计**：关键配置、依赖升级、schema 变更需在 PR 中注明影响范围，并在阶段总结会上归档。
